#!/usr/bin/env bash
set -euo pipefail

USERNAME=volgactf
IMAGE=volgactf-final-devenv-checker
VERSION=$(cat VERSION)

# Allow custom registry as first argument
REGISTRY="${1:-}"

if [[ -n "$REGISTRY" ]]; then
    IMAGE_NAME="$REGISTRY/$USERNAME/$IMAGE"
else
    IMAGE_NAME="$USERNAME/$IMAGE"
fi

docker buildx build \
	--platform linux/amd64,linux/arm64 \
	--build-arg BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ') \
	--build-arg BUILD_VERSION=$VERSION \
	--build-arg VCS_REF=$(git rev-parse --short HEAD) \
	-t $IMAGE_NAME:$VERSION \
	-t $IMAGE_NAME:latest \
	--push .
